# キセカLINEボット

これは「キセカ」という単語に反応して、元気な妹風の返事をしてくれるシンプルなLINEボットです。

## プロジェクト概要

- **言語**: Node.js
- **フレームワーク**: Express
- **LINE SDK**: @line/bot-sdk

## デプロイまでの道のり

このボットを24時間稼働させるため、クラウドサービスへのデプロイを行いました。

1.  **クラウドサービスの選定**
    - 無料で利用でき、GitHubからの自動デプロイに対応している **Render** を選択しました。

2.  **デプロイの試行とエラーハンドリング**
    - **初回デプロイ失敗**:
        - **原因**: `package.json`内の`scripts` -> `test`の値に含まれるダブルクォーテーションがエスケープされておらず、JSONの構文エラー（`EJSONPARSE`）が発生。
        - **ログ**: `npm error JSON.parse Expected ',' or '}' after property value...`
    - **修正と再デプロイ失敗**:
        - **原因**: 構文エラーの修正時に、`"test"`というキー名の最初のダブルクォーテーションまで誤って削除してしまい、再度JSON構文エラーが発生。
        - **ログ**: `npm error JSON.parse Expected double-quoted property name...`
    - **最終的な修正と成功**:
        - `package.json`の構文を正しく修正し、GitHubにプッシュ。
        - Render側で自動デプロイが実行され、ビルドとデプロイに成功しました。

3.  **最終設定**
    - Renderで発行されたサービスURL（`https://kiseka-line.onrender.com`）の末尾に`/webhook`を付与。
    - 上記URLをLINE DevelopersコンソールのWebhook URLに設定し、全工程が完了しました。

4.  **AI機能の統合**
    - Google Gemini APIを導入し、ボットの応答をAIが生成するように変更しました。
    - `package.json`に`@google/generative-ai`パッケージを追加。
    - `index.js`を修正し、Gemini APIを呼び出すロジックと、キセカのペルソナを定義したプロンプトを追加。
    - Renderの環境変数に`GEMINI_API_KEY`を設定する必要がありました。

5.  **AIモデル呼び出しエラーの修正**
    - デプロイ後、AIモデルの呼び出しで`404 Not Found`エラーが発生。
    - **原因**: `gemini-pro`モデルがAPIバージョン`v1beta`で利用できない、または見つからないため。
    - **修正**: `index.js`内のモデル名を`gemini-1.5-flash`に変更。

6.  **キセカのふるまい設定の追加**
    - ユーザーから提供された詳細なペルソナ設定を`index.js`内のAIプロンプトに反映させました。これにより、キセカの応答がより個性的になりました。

7.  **応答速度に関する考察**
    - LINEからの返信に時間がかかる場合があることが確認されました。
    - **主な原因**:
        - **AIモデルの応答時間**: AIが応答を生成するのに時間がかかるため。
        - **Renderの無料プランの特性（コールドスタート）**: 一定時間アクセスがないとサービスが一時停止し、次のリクエスト時に起動に時間がかかるため（最大50秒以上の遅延）。
    - **改善策**: Renderの有料プランへのアップグレードが最も効果的です。

## 現在の状況と課題

*   **LINEボットの基本機能**:
    *   LINEからのメッセージ受信、AIによる応答生成、LINEへの返信が正常に動作しています。
    *   キセカのAIペルソナも詳細に設定され、反映済みです。
*   **課題 - 定期メッセージのデプロイ**:
    *   朝の起床メッセージ（`morning_message.js`）を定期実行する機能の実装を進めていました。
    *   RenderのCronジョブ機能を利用する計画でしたが、RenderがCronジョブの利用にクレジットカード情報の入力を必須としているため、現時点ではデプロイがブロックされています。
    *   Renderの「Starter」プランは非常に低コストですが、完全に無料ではありません。

## 次回の実行内容

**目標**: キセカの起床メッセージを毎日午前6時30分（日本時間）に自動送信する機能を実装する。

**優先順位**: クレジットカード情報の入力なしで実現可能な方法を優先する。

### 実行計画

1.  **Render Cronジョブの代替案の検討と実行**:
    *   **Renderでの解決策の再確認**:
        *   RenderのCronジョブで、クレジットカードなしで利用できる方法がないか、公式ドキュメントやコミュニティを再確認する。
        *   もし、Webサービス（`kiseka-line`）の無料枠でCronジョブを代替できるような機能（例: 内部スケジューラ）がないか調査する。
    *   **Glitchでの実装検討**:
        *   Renderでの解決が難しい場合、**Glitch** を利用して `morning_message.js` を定期実行する方法を検討する。
        *   **手順**:
            1.  Glitchアカウントにサインアップする（未登録の場合）。
            2.  新しいプロジェクトを作成し、GitHubリポジトリ (`https://github.com/lo25ve25AI-tk/kiseka-line.git`) をインポートする。
            3.  Glitchプロジェクト内で `morning_message.js` を定期実行するメカニズムを確立する。
                *   Glitchの組み込みスケジューラ機能（もしあれば）を利用する。
                *   または、`node-cron`などのnpmパッケージを導入し、`morning_message.js`を呼び出す別のスクリプトを作成し、それをGlitch上で常時実行させる方法を検討する。
            4.  Glitchプロジェクトの環境変数に `CHANNEL_ACCESS_TOKEN`, `CHANNEL_SECRET`, `TARGET_LINE_USER_ID` (`2004385908`) を設定する。
            5.  起床メッセージが正しく送信されるかテストする。
    *   **その他の無料スケジューラサービスの調査**:
        *   Glitchでも解決が難しい場合、無料で利用でき、LINEへのメッセージ送信が可能な他の外部スケジューラサービス（例: Zapierの無料枠、IFTTTなど）を調査し、利用を検討する。

2.  **`README.md`の更新**:
    *   上記実行計画の進捗に応じて、この`README.md`ファイルを適宜更新し、開発記録として残す。

## 追加機能と改善点

このプロジェクトには、`README.md`に明示的に記載されていなかったものの、ボットの機能性や堅牢性を高めるための重要な実装がいくつか含まれています。

### 1. 会話履歴の保持と利用 (`index.js`)
*   ユーザーごとの会話履歴を最大10ターン（ユーザーとキセカのやり取りで20エントリ）まで保持し、AIの応答生成時に過去の文脈を考慮しています。これにより、より自然で連続性のある会話が可能です。

### 2. AIモデル呼び出しエラー時のフォールバックメッセージ (`index.js`)
*   Google Gemini APIからの応答生成中にエラーが発生した場合、ユーザー体験を損なわないように、固定の謝罪メッセージを返信するエラーハンドリングが実装されています。

### 3. 環境変数による設定の外部化
*   LINE Botのチャネル設定（`CHANNEL_ACCESS_TOKEN`, `CHANNEL_SECRET`）、Gemini APIキー（`GEMINI_API_KEY`）、定期メッセージの送信先ユーザーID（`TARGET_LINE_USER_ID`）など、機密情報や環境に依存する設定値はすべて環境変数として外部化されています。これにより、セキュリティが向上し、異なる環境へのデプロイが容易になっています。
